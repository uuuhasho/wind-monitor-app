<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°ä¸­å¤©ç„¶æ°£èˆ¹é€²æ¸¯ç›£æ¸¬ (NV2)</title>
    <link rel="apple-touch-icon" href="app_icon.png">
    <link rel="icon" href="app_icon.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: #f0f2f5; }
        .btn { @apply px-4 py-3 rounded-lg font-bold shadow transition-all active:scale-95 flex items-center justify-center gap-2; }
        
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #3498db;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: none;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* èˆŠè³‡æ–™éæ¸¡æ•ˆæœ */
        .stale-data { opacity: 0.5; transition: opacity 0.5s; }

        /* è¼¸å…¥æ¡†é–å®šæ¨£å¼ */
        input:disabled {
            background-color: #e5e7eb;
            color: #6b7280;
            cursor: not-allowed;
            border-color: #d1d5db;
        }
    </style>
</head>
<body class="p-4 max-w-lg mx-auto min-h-screen flex flex-col">

    <header class="text-center mb-6">
        <h1 class="text-2xl font-extrabold text-gray-800">å°ä¸­å¤©ç„¶æ°£èˆ¹é€²æ¸¯ç›£æ¸¬</h1>
        
        <div class="bg-indigo-50 border border-indigo-200 text-indigo-700 px-3 py-2 mt-2 rounded-lg text-xs font-medium flex items-center justify-center gap-2">
            <i data-lucide="cloud" class="w-4 h-4"></i>
            <span>é›²ç«¯ç›£æ§ä¸­ (NV2 æ™ºæ…§æ’ç¨‹ç‰ˆ)</span>
        </div>
    
        <div class="flex items-center justify-center gap-2 mt-2">
            <div id="loading-indicator" class="loader"></div>
            <p class="text-xs text-gray-500" id="status-text">æº–å‚™å°±ç·’</p>
        </div>
    </header>

    <div class="bg-white rounded-2xl p-6 shadow-lg border border-gray-100 mb-6 text-center relative overflow-hidden">
        
        <div class="absolute top-0 left-0 w-full h-1 bg-gray-200">
            <div id="progress-bar" class="h-full bg-blue-500 transition-all duration-500" style="width: 0%"></div>
        </div>
        
        <h3 class="text-gray-400 text-sm font-medium mb-1">å³æ™‚é¢¨é€Ÿ</h3>
        <div class="text-5xl font-black text-gray-800 tracking-tight mb-2 flex justify-center items-end gap-2">
            <span id="wind-value">--</span>
            <span class="text-lg text-gray-400 font-normal mb-2">m/s</span>
        </div>
        <p class="text-xs text-gray-400 mb-4" id="last-fetch-time">æœ€å¾Œæ›´æ–°ï¼š--</p>

        <div class="grid grid-cols-2 gap-3 mb-2 text-left bg-gray-50 p-3 rounded-xl border border-gray-200">
            <div class="col-span-1">
                <label class="block text-xs font-bold text-gray-500 mb-1">èˆ¹å</label>
                <input type="text" id="input-ship-name" class="w-full border border-gray-300 rounded px-2 py-1 text-sm focus:outline-none focus:border-blue-500 transition-colors" placeholder="è¼¸å…¥èˆ¹å...">
            </div>
            <div class="col-span-1">
                <label class="block text-xs font-bold text-gray-500 mb-1">é™åˆ¶é¢¨é€Ÿ (m/s)</label>
                <input type="number" id="input-limit-speed" step="0.1" class="w-full border border-gray-300 rounded px-2 py-1 text-sm focus:outline-none focus:border-blue-500 transition-colors" placeholder="ä¾‹å¦‚ 12.0">
            </div>
        </div>
        
        <div id="mode-display" class="hidden flex items-center justify-center gap-2 px-3 py-1 rounded-full bg-green-100 text-green-700 text-xs font-bold animate-pulse">
            <span id="mode-icon">ğŸŸ¢</span>
            <span id="mode-text">ç›£æ§é‹è¡Œä¸­</span>
        </div>

    </div>

    <div class="grid grid-cols-2 gap-3 mb-8">
        <button id="btn-start" class="btn bg-green-600 hover:bg-green-700 text-white col-span-1">
            <i data-lucide="play" class="fill-current"></i> é–‹å§‹
        </button>
        <button id="btn-stop" class="btn bg-white border border-gray-300 hover:bg-gray-100 text-red-600 font-bold col-span-1">
            <i data-lucide="x-square" class="w-5 h-5"></i> çµæŸ
        </button>
    </div>

    <div class="text-center text-xs text-gray-400 mt-auto">
        <p>ç³»çµ±æ”¯æ´æ¯æ—¥è‡ªå‹•æ’ç¨‹ (04:30-17:30)ã€‚</p>
        <p>æ‚¨äº¦å¯éš¨æ™‚æ‰‹å‹•é–‹å§‹æˆ–çµæŸã€‚</p>
    </div>

    <script>
        // --- 1. æ ¸å¿ƒè¨­å®š ---
        // â˜…â˜…â˜… è«‹ç¢ºèªæ­¤ç¶²å€ç‚ºæ‚¨éƒ¨ç½²çš„æœ€æ–° GAS ç¶²å€ â˜…â˜…â˜…
        const FIXED_GAS_API_URL = "https://script.google.com/macros/s/AKfycbwSs0kDZbl6Whua7UKmUMk1rlCuFgJHFhSIUA0nVTVmLujhrlbVXdiem4rN5WJIEg9brA/exec?";
        let refreshTimer = null;
        
        // --- 2. UI å…ƒç´  ---
        const els = {
            btnStart: document.getElementById('btn-start'), 
            btnStop: document.getElementById('btn-stop'),
            windValue: document.getElementById('wind-value'),
            statusText: document.getElementById('status-text'),
            modeDisplay: document.getElementById('mode-display'),
            modeText: document.getElementById('mode-text'),
            lastFetchTime: document.getElementById('last-fetch-time'),
            loading: document.getElementById('loading-indicator'),
            progressBar: document.getElementById('progress-bar'),
            inputShip: document.getElementById('input-ship-name'),
            inputLimit: document.getElementById('input-limit-speed')
        };

        // --- 3. äº‹ä»¶ç¶å®š ---
        
        els.btnStart.addEventListener('click', () => {
            const name = els.inputShip.value.trim();
            const limit = els.inputLimit.value.trim();

            if (!name) { alert('è«‹è¼¸å…¥èˆ¹å'); return; }
            if (!limit || isNaN(limit)) { alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„é™åˆ¶é¢¨é€Ÿæ•¸å­—'); return; }

            setCloudMode('start', name, limit);
        });
        
        els.btnStop.addEventListener('click', () => {
            if(confirm('ç¢ºå®šè¦åœæ­¢ç›£æ§å—ï¼Ÿé€™å°‡æœƒæ¸…é™¤ç›®å‰çš„è¨­å®šã€‚')) {
                setCloudMode('stop');
            }
        });

        // --- 4. èˆ‡ GAS é€šè¨Šé‚è¼¯ ---

        async function setCloudMode(mode, shipName = '', limitSpeed = '') {
            
            // æ¨‚è§€ UIï¼šåœæ­¢æ™‚ç«‹å³æ¸…ç©º
            if (mode === 'stop') {
                updateUIState('stop'); 
                localStorage.setItem('local_mode', 'stop');
                localStorage.removeItem('local_ship');
                localStorage.removeItem('local_limit');
                localStorage.removeItem('local_is_auto');
            }

            els.loading.style.display = 'inline-block';
            els.statusText.textContent = 'å‚³é€æŒ‡ä»¤ä¸­...';
            
            try {
                const timestamp = new Date().getTime();
                let url = `${FIXED_GAS_API_URL}action=set_mode&mode=${mode}&t=${timestamp}`;
                if (mode === 'start') {
                    url += `&ship_name=${encodeURIComponent(shipName)}&limit_speed=${encodeURIComponent(limitSpeed)}`;
                }
                
                const response = await fetch(url, { method: 'GET' });
                if (!response.ok) throw new Error('GAS å›æ‡‰éŒ¯èª¤');
                
                if (mode === 'start') {
                    // æ‰‹å‹•é–‹å§‹ï¼ŒisAuto ç‚º false
                    updateUIState('start', shipName, limitSpeed, false);
                    localStorage.setItem('local_mode', 'start');
                    localStorage.setItem('local_ship', shipName);
                    localStorage.setItem('local_limit', limitSpeed);
                    localStorage.setItem('local_is_auto', 'false');
                }
                
                els.statusText.textContent = 'è¨­å®šå®Œæˆ';
                fetchDisplayData(); 
                
            } catch (e) {
                alert('é€£ç·šå¤±æ•—: ' + e.message);
            } finally {
                els.loading.style.display = 'none';
            }
        }

        async function fetchDisplayData() {
            els.loading.style.display = 'inline-block';
            
            // è®€å–æœ¬åœ°å¿«å–
            const cachedSpeed = localStorage.getItem('local_speed');
            const cachedTime = localStorage.getItem('local_time');
            const cachedMode = localStorage.getItem('local_mode');
            const cachedShip = localStorage.getItem('local_ship');
            const cachedLimit = localStorage.getItem('local_limit');
            const cachedIsAuto = localStorage.getItem('local_is_auto') === 'true';

            if (cachedSpeed) {
                els.windValue.textContent = cachedSpeed;
                els.windValue.classList.add('stale-data');
                els.lastFetchTime.textContent = `ä¸Šæ¬¡ç´€éŒ„ï¼š${cachedTime} (æ›´æ–°ä¸­...)`;
            }
            
            if (cachedMode === 'start') {
                updateUIState('start', cachedShip, cachedLimit, cachedIsAuto);
            } else {
                updateUIState('stop');
            }
            
            try {
                const res = await fetch(`${FIXED_GAS_API_URL}action=display`);
                if (!res.ok) throw new Error('GAS é€£ç·šéŒ¯èª¤');
                const data = await res.json();

                if (data.speed) {
                    els.windValue.textContent = data.speed;
                    els.windValue.classList.remove('stale-data');
                    var nowStr = new Date().toLocaleTimeString('zh-TW', { hour12: false });
                    els.lastFetchTime.textContent = `æœ€å¾Œæ›´æ–°ï¼š${nowStr}`;
                    
                    localStorage.setItem('local_speed', data.speed);
                    localStorage.setItem('local_time', nowStr);
                }

                if (data.currentMode === 'start') {
                    // é€™è£¡çš„ isAuto ä¾†è‡ªå¾Œç«¯å±¬æ€§
                    updateUIState('start', data.shipName, data.limitSpeed, data.isAuto);
                    localStorage.setItem('local_mode', 'start');
                    localStorage.setItem('local_ship', data.shipName);
                    localStorage.setItem('local_limit', data.limitSpeed);
                    localStorage.setItem('local_is_auto', data.isAuto);
                } else {
                    if (cachedMode === 'start') {
                         // alert('ç›£æ§å·²åœæ­¢'); // å¯ä¾éœ€æ±‚é–‹å•Ÿæé†’
                    }
                    updateUIState('stop');
                    localStorage.setItem('local_mode', 'stop');
                }
                
                els.statusText.textContent = "è³‡æ–™åŒæ­¥å®Œæˆ";

            } catch (e) {
                console.error('Fetch failed', e);
                els.statusText.textContent = 'é€£ç·šç•°å¸¸';
            } finally {
                els.loading.style.display = 'none';
            }
        }

        function updateUIState(mode, shipName, limitSpeed, isAuto) {
            els.progressBar.style.width = '0%';
            
            if (mode === 'start') {
                els.btnStart.classList.add('opacity-50', 'cursor-not-allowed');
                els.btnStart.disabled = true;
                
                if(shipName) els.inputShip.value = shipName;
                if(limitSpeed) els.inputLimit.value = limitSpeed;
                
                els.inputShip.disabled = true;
                els.inputLimit.disabled = true;

                els.modeDisplay.classList.remove('hidden');
                
                // å€åˆ† è‡ªå‹•æ’ç¨‹ vs æ‰‹å‹•ç›£æ§ çš„é¡¯ç¤ºæ–‡å­—
                if (isAuto) {
                    els.modeText.textContent = `è‡ªå‹•æ’ç¨‹ä¸­: ${shipName} (é™é€Ÿ${limitSpeed})`;
                    els.modeDisplay.className = "flex items-center justify-center gap-2 px-3 py-1 rounded-full bg-blue-100 text-blue-700 text-xs font-bold animate-pulse";
                } else {
                    els.modeText.textContent = `æ‰‹å‹•ç›£æ§ä¸­: ${shipName} (é™é€Ÿ${limitSpeed})`;
                    els.modeDisplay.className = "flex items-center justify-center gap-2 px-3 py-1 rounded-full bg-green-100 text-green-700 text-xs font-bold animate-pulse";
                }
                
            } else {
                els.btnStart.classList.remove('opacity-50', 'cursor-not-allowed');
                els.btnStart.disabled = false;
                
                els.inputShip.disabled = false;
                els.inputLimit.disabled = false;
                
                els.inputShip.value = '';
                els.inputLimit.value = '';

                els.modeDisplay.classList.add('hidden');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            fetchDisplayData();
            refreshTimer = setInterval(fetchDisplayData, 30000); 
        });
    </script>
</body>
</html>
