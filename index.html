<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>台中天然氣船進港監測 (NV1)</title>
    <link rel="apple-touch-icon" href="app_icon.png">
    <link rel="icon" href="app_icon.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: #f0f2f5; }
        .btn { @apply px-4 py-3 rounded-lg font-bold shadow transition-all active:scale-95 flex items-center justify-center gap-2; }
        
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #3498db;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: none;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* 舊資料過渡效果 */
        .stale-data { opacity: 0.5; transition: opacity 0.5s; }

        /* 輸入框鎖定樣式 */
        input:disabled {
            background-color: #e5e7eb; /* gray-200 */
            color: #6b7280; /* gray-500 */
            cursor: not-allowed;
            border-color: #d1d5db;
        }
    </style>
</head>
<body class="p-4 max-w-lg mx-auto min-h-screen flex flex-col">

    <header class="text-center mb-6">
        <h1 class="text-2xl font-extrabold text-gray-800">台中天然氣船進港監測</h1>
        
        <div class="bg-indigo-50 border border-indigo-200 text-indigo-700 px-3 py-2 mt-2 rounded-lg text-xs font-medium flex items-center justify-center gap-2">
            <i data-lucide="cloud" class="w-4 h-4"></i>
            <span>雲端監控中 (NV1版)</span>
        </div>
    
        <div class="flex items-center justify-center gap-2 mt-2">
            <div id="loading-indicator" class="loader"></div>
            <p class="text-xs text-gray-500" id="status-text">準備就緒</p>
        </div>
    </header>

    <div class="bg-white rounded-2xl p-6 shadow-lg border border-gray-100 mb-6 text-center relative overflow-hidden">
        
        <div class="absolute top-0 left-0 w-full h-1 bg-gray-200">
            <div id="progress-bar" class="h-full bg-blue-500 transition-all duration-500" style="width: 0%"></div>
        </div>
        
        <h3 class="text-gray-400 text-sm font-medium mb-1">即時風速</h3>
        <div class="text-5xl font-black text-gray-800 tracking-tight mb-2 flex justify-center items-end gap-2">
            <span id="wind-value">--</span>
            <span class="text-lg text-gray-400 font-normal mb-2">m/s</span>
        </div>
        <p class="text-xs text-gray-400 mb-4" id="last-fetch-time">最後更新：--</p>

        <div class="grid grid-cols-2 gap-3 mb-2 text-left bg-gray-50 p-3 rounded-xl border border-gray-200">
            <div class="col-span-1">
                <label class="block text-xs font-bold text-gray-500 mb-1">船名</label>
                <input type="text" id="input-ship-name" class="w-full border border-gray-300 rounded px-2 py-1 text-sm focus:outline-none focus:border-blue-500 transition-colors" placeholder="輸入船名...">
            </div>
            <div class="col-span-1">
                <label class="block text-xs font-bold text-gray-500 mb-1">限制風速 (m/s)</label>
                <input type="number" id="input-limit-speed" step="0.1" class="w-full border border-gray-300 rounded px-2 py-1 text-sm focus:outline-none focus:border-blue-500 transition-colors" placeholder="例如 12.0">
            </div>
        </div>
        <div id="mode-display" class="hidden inline-block px-3 py-1 rounded-full bg-green-100 text-green-700 text-xs font-bold animate-pulse">
            監控運行中
        </div>

    </div>

    <div class="grid grid-cols-2 gap-3 mb-8">
        <button id="btn-start" class="btn bg-green-600 hover:bg-green-700 text-white col-span-1">
            <i data-lucide="play" class="fill-current"></i> 開始
        </button>
        <button id="btn-stop" class="btn bg-white border border-gray-300 hover:bg-gray-100 text-red-600 font-bold col-span-1">
            <i data-lucide="x-square" class="w-5 h-5"></i> 結束
        </button>
    </div>

    <div class="text-center text-xs text-gray-400 mt-auto">
        <p>按下「開始」後，船名與限速將鎖定。</p>
        <p>如需更改設定，請先按下「結束」。</p>
    </div>

    <script>
        // --- 1. 核心設定 ---
        // ★★★ 請確認此網址為您部署的最新 GAS 網址 ★★★
        const FIXED_GAS_API_URL = "https://script.google.com/macros/s/AKfycbwSs0kDZbl6Whua7UKmUMk1rlCuFgJHFhSIUA0nVTVmLujhrlbVXdiem4rN5WJIEg9brA/exec?";
        let refreshTimer = null;
        
        // --- 2. UI 元素 ---
        const els = {
            btnStart: document.getElementById('btn-start'), 
            btnStop: document.getElementById('btn-stop'),
            windValue: document.getElementById('wind-value'),
            statusText: document.getElementById('status-text'),
            modeDisplay: document.getElementById('mode-display'),
            lastFetchTime: document.getElementById('last-fetch-time'),
            loading: document.getElementById('loading-indicator'),
            progressBar: document.getElementById('progress-bar'),
            inputShip: document.getElementById('input-ship-name'),
            inputLimit: document.getElementById('input-limit-speed')
        };

        // --- 3. 事件綁定 ---
        
        els.btnStart.addEventListener('click', () => {
            const name = els.inputShip.value.trim();
            const limit = els.inputLimit.value.trim();

            if (!name) { alert('請輸入船名'); return; }
            if (!limit || isNaN(limit)) { alert('請輸入有效的限制風速數字'); return; }

            setCloudMode('start', name, limit);
        });
        
        els.btnStop.addEventListener('click', () => {
            if(confirm('確定要停止監控嗎？這將會清除目前的船名設定。')) {
                setCloudMode('stop');
            }
        });

        // --- 4. 與 GAS 通訊邏輯 ---

        async function setCloudMode(mode, shipName = '', limitSpeed = '') {
            
            // ★★★ 關鍵修改：樂觀 UI 更新 (如果是 Stop，先更新畫面，不等伺服器) ★★★
            if (mode === 'stop') {
                updateUIState('stop'); // 立即解鎖並清空
                
                // 立即清除本地快取
                localStorage.setItem('local_mode', 'stop');
                localStorage.removeItem('local_ship');
                localStorage.removeItem('local_limit');
            }

            els.loading.style.display = 'inline-block';
            els.statusText.textContent = '傳送指令中...';
            
            try {
                const timestamp = new Date().getTime();
                let url = `${FIXED_GAS_API_URL}action=set_mode&mode=${mode}&t=${timestamp}`;
                if (mode === 'start') {
                    url += `&ship_name=${encodeURIComponent(shipName)}&limit_speed=${encodeURIComponent(limitSpeed)}`;
                }
                
                // 背景發送請求
                const response = await fetch(url, { method: 'GET' });
                if (!response.ok) throw new Error('GAS 回應錯誤');
                
                // 如果是 Start，成功後才更新 UI (避免資料沒送出就鎖定)
                if (mode === 'start') {
                    updateUIState('start', shipName, limitSpeed);
                    
                    localStorage.setItem('local_mode', 'start');
                    localStorage.setItem('local_ship', shipName);
                    localStorage.setItem('local_limit', limitSpeed);
                }
                
                // 如果是 Stop，UI 已經在最上面更新過了，這裡不需要再做一次

                els.statusText.textContent = '設定完成';
                fetchDisplayData(); 
                
            } catch (e) {
                alert('連線失敗，請檢查網路: ' + e.message);
                // 如果 Stop 失敗，理論上應該要把 UI 鎖回去，但為了體驗，通常保持解鎖即可
            } finally {
                els.loading.style.display = 'none';
            }
        }

        async function fetchDisplayData() {
            els.loading.style.display = 'inline-block';
            
            // --- 讀取本地快取 ---
            const cachedSpeed = localStorage.getItem('local_speed');
            const cachedTime = localStorage.getItem('local_time');
            const cachedMode = localStorage.getItem('local_mode');
            const cachedShip = localStorage.getItem('local_ship');
            const cachedLimit = localStorage.getItem('local_limit');

            if (cachedSpeed) {
                els.windValue.textContent = cachedSpeed;
                els.windValue.classList.add('stale-data');
                els.lastFetchTime.textContent = `上次紀錄：${cachedTime} (更新中...)`;
            }
            
            if (cachedMode === 'start') {
                updateUIState('start', cachedShip, cachedLimit);
            } else {
                updateUIState('stop');
            }
            
            try {
                // --- 與 GAS 同步 ---
                const res = await fetch(`${FIXED_GAS_API_URL}action=display`);
                if (!res.ok) throw new Error('GAS 連線錯誤');
                const data = await res.json();

                if (data.speed) {
                    els.windValue.textContent = data.speed;
                    els.windValue.classList.remove('stale-data');
                    var nowStr = new Date().toLocaleTimeString('zh-TW', { hour12: false });
                    els.lastFetchTime.textContent = `最後更新：${nowStr}`;
                    
                    localStorage.setItem('local_speed', data.speed);
                    localStorage.setItem('local_time', nowStr);
                }

                if (data.currentMode === 'start') {
                    updateUIState('start', data.shipName, data.limitSpeed);
                    localStorage.setItem('local_mode', 'start');
                    localStorage.setItem('local_ship', data.shipName);
                    localStorage.setItem('local_limit', data.limitSpeed);
                } else {
                    // 如果後端是 stop
                    // 這裡加一個判斷：如果前端原本是 start，才跳通知，避免不斷跳出
                    if (cachedMode === 'start') {
                         alert('監控已由其他裝置停止');
                    }
                    updateUIState('stop');
                    localStorage.setItem('local_mode', 'stop');
                }
                
                els.statusText.textContent = "資料同步完成";

            } catch (e) {
                console.error('Fetch failed', e);
                els.statusText.textContent = '連線異常';
            } finally {
                els.loading.style.display = 'none';
            }
        }

        function updateUIState(mode, shipName, limitSpeed) {
            els.progressBar.style.width = '0%';
            
            if (mode === 'start') {
                // 鎖定狀態
                els.btnStart.classList.add('opacity-50', 'cursor-not-allowed');
                els.btnStart.disabled = true;
                
                if(shipName) els.inputShip.value = shipName;
                if(limitSpeed) els.inputLimit.value = limitSpeed;
                
                els.inputShip.disabled = true;
                els.inputLimit.disabled = true;

                els.modeDisplay.classList.remove('hidden');
                els.modeDisplay.textContent = `監控中: ${shipName} (限速${limitSpeed})`;
                
            } else {
                // 停止狀態 -> 開放狀態
                els.btnStart.classList.remove('opacity-50', 'cursor-not-allowed');
                els.btnStart.disabled = false;
                
                // 解鎖輸入框
                els.inputShip.disabled = false;
                els.inputLimit.disabled = false;
                
                // ★★★ 強制清空 (不管之前是不是鎖定的，只要變回 Stop 就清空) ★★★
                els.inputShip.value = '';
                els.inputLimit.value = '';

                els.modeDisplay.classList.add('hidden');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            fetchDisplayData();
            refreshTimer = setInterval(fetchDisplayData, 30000); 
        });
    </script>
</body>
</html>
